---
title: "Deconstructing Variable Relationships through Conditional Independence Testing"
author: "Mingzhe Liu"
format: html
editor: visual
---

# 1

## (a)

```{=latex}
\begin{align}
\text{Cov}(X, Y | Z) &= E\left[\left(X - E[X | Z]\right)\left(Y - E[Y | Z]\right) | Z\right] \\
&= E\left[\left(X - E[X | Z]\right)\left(\alpha + \beta X + \gamma Z + U - (\alpha + \beta E[X | Z] + \gamma Z)\right) | Z\right] \\
&= E\left[\left(X - E[X | Z]\right)\left(\beta X + U - \beta E[X | Z]\right) | Z\right] \\
&= \beta E\left[\left(X - E[X | Z]\right)^2 | Z\right] + E\left[\left(X - E[X | Z]\right)U | Z\right] \\
&= \beta \text{Var}(X | Z) + 0 \\
&= \beta \text{Var}(X | Z) \text{, as } E[U | Z] = 0 \text{ and } U \text{ is independent of } X \text{ and } Z.
\end{align}
```

$\beta = \frac{\text{Cov}(X, Y | Z)}{\text{Var}(X | Z)}$

## (b)

```{=latex}
\begin{align}
\text{Cov}(\hat{X}, Y) &= E[\hat{X}Y] - E[\hat{X}]E[Y] \\
&= E[(X - E[X|Z])(\alpha + \beta X + \gamma Z + U)] - E[\hat{X}]E[\alpha + \beta E[X] + \gamma E[Z] + E[U]] \\
&= \beta E[(X - E[X|Z])^2] \quad \text{(as \( E[U] = 0 \) and \( E[\hat{X}] = 0 \))}.
\end{align}
```

```{=latex}
\begin{align*}
\text{Var}(\hat{X}) &= E[\hat{X}^2] - (E[\hat{X}])^2 \\
&= E[(X - E[X|Z])^2] \quad \text{(since \( E[\hat{X}] = 0 \))}.
\end{align*}
```

```{=latex}
\begin{align}
\beta &= \frac{\beta E[(X - E[X|Z])^2]}{E[(X - E[X|Z])^2]}  \\
&= \beta
\end{align}
```

# 2

```{r}
Q2 <- structure(list(Z = c(2.5, 3.9, 6.6, 4.7, 4.4, 4.5, 5.3, 4.7, 6.2, 4.8, 5.5, 5.9, 4.7, 6.4, 4.8, 4.4, 4.8, 3.2, 5.4,
2.9, 4.6, 5.6, 4.7, 4.3, 5.9, 4.7, 6.2, 3.8, 4.6, 5.7, 5.3, 4.6, 5.3, 5, 5.9, 5.1, 6.1, 4.5, 4.2, 5.8, 3.8, 4.6, 4.7, 5.9, 6.2,
4.2, 3.9, 1.5, 5.8, 6.1, 4.3, 4.6, 5.8, 5, 5.6, 3.5, 6.1, 5.7, 7.3, 3.6, 3.4, 5.2, 6.4, 4.9, 4.1, 3.6, 5.8, 3.6, 3.6, 4.5, 5.2,
4.8, 3.7, 3.8, 6.1, 6.3, 3.9, 4.2, 5.2, 4.1, 5, 4.3, 4.7, 4.9, 3, 4.5, 4.6, 3.8, 6.6, 4.5, 2.8, 4.9, 4.7, 5.1, 4, 4.8, 5.6, 6.4,
6.1, 3.8), D = c(0L, 0L, 1L, 0L, 1L, 1L, 0L, 0L, 1L, 0L, 0L, 1L, 1L, 1L, 0L, 0L, 1L, 0L, 1L, 0L, 0L, 1L, 0L,
1L, 0L, 1L, 1L, 0L, 1L, 1L, 1L, 0L, 0L, 1L, 1L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 1L, 1L, 1L, 0L, 0L, 1L, 1L, 1L,
1L, 0L, 0L, 1L, 0L, 1L, 1L, 1L, 0L, 1L, 0L, 1L, 0L, 1L, 0L, 0L, 0L, 0L, 0L, 1L, 1L, 0L, 0L, 1L, 1L, 1L, 0L, 1L,
1L, 1L, 0L, 1L, 0L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 0L, 0L, 1L, 0L, 0L, 1L, 1L, 0L, 0L), Y = c(7.4, 10.7, 16.6,
13.5, 15.7, 15.2, 17.6, 15, 16.4, 13.9, 13.3, 16.7, 15.2, 17.2, 15, 13.4, 14.2, 9.9, 15.5, 7.4, 14.2, 15.1, 14.5, 13.2,
17.1, 13.7, 15.5, 13.1, 14.5, 14.5, 15.4, 14.5, 17.6, 12.9, 15.8, 16.7, 17.4, 14.3, 11.7, 18.3, 12.9, 15.5, 15.8, 16.2,
15.4, 14.3, 10.5, 5.3, 16.6, 15.5, 14.6, 12, 17.1, 15, 16.1, 10.8, 16.4, 14.4, 16.3, 10.8, 14.9, 15.8, 16.2, 16.9, 13.8,
10.9, 18.5, 11.9, 12.3, 13.1, 13.6, 14.3, 12.1, 10.6, 16.5, 15.2, 14.1, 11.6, 14.7, 14.4, 14.8, 12.7, 15.2, 14.9, 7.7,
11.9, 14.4, 11.9, 16.4, 12.7, 7, 16.1, 14.6, 14.7, 10.8, 14.9, 14, 14.8, 19.8, 10)), class = "data.frame", row.names
= c(NA, -100L))

```

## (a)

```{r}
summary(lm(Y~D+Z+D:Z, data=Q2))
```

```{r}
model <- lm(Y ~ D + Z + D:Z, data=Q2)
summary(model)
colors <- ifelse(Q2$D == 1, "red", "blue")
plot(Q2$Z, Q2$Y, col = colors, 
     xlab = "Confounder Z", ylab = "Outcome Y", 
     main = "Scatterplot with Regression Lines by Treatment Status")


subset_0 <- Q2[Q2$D == 0, ]
model_0 <- lm(Y ~ Z, data = subset_0)
abline(model_0, col = "blue")

subset_1 <- Q2[Q2$D == 1, ]
model_1 <- lm(Y ~ Z, data = subset_1)
abline(model_1, col = "red")

legend("topright", legend = c("D = 0", "D = 1"), col = c("blue", "red"), lty = 1)

```

## (b)

```{r}
coeffs <- coef(model)
mean_Z<- mean(Q2$Z)

Y1<- coeffs['(Intercept)'] + coeffs['D'] + coeffs['Z'] * mean_Z+ coeffs['D:Z'] * mean_Z
Y0<- coeffs['(Intercept)'] + coeffs['Z'] * mean_Z

ATE <- Y1-Y0

mean_Z_treated <- mean(Q2$Z[Q2$D == 1])
mean_Z_control <- mean(Q2$Z[Q2$D == 0])

Y1_treated <- coeffs['(Intercept)'] + coeffs['D'] + coeffs['Z'] * mean_Z_treated + coeffs['D:Z'] * mean_Z_treated
Y0_treated <- coeffs['(Intercept)'] + coeffs['Z'] * mean_Z_treated

Y1_control <- coeffs['(Intercept)'] + coeffs['D'] + coeffs['Z'] * mean_Z_control + coeffs['D:Z'] * mean_Z_control
Y0_control <- coeffs['(Intercept)'] + coeffs['Z'] * mean_Z_control

ATT <- Y1_treated - Y0_treated
ATC <- Y1_control - Y0_control

print(paste(ATE))
print(paste(ATT))
print(paste(ATC))

```

## (c)

```{r}
Q2a <- structure(list(Z = c(1.5, 3.3, 1.5, 2.8, 4.8, 1.1, 2.2, 1.1, 2.1, 3.3, 3.7, 3.1, 2.1, 2.1, 2.6, 2.8, 1.5, 0.2, 2.8,
1.2, 2.5, 1.2, 2.3, 1.3, 3.6, 1, 2.4, 1.2, 1.7, 1.9, 3.6, 3.8, 1.1, 1.6, 3, 2.4, 2.2, 1.7, 1.8, 3.6, 2.9, 0.9, 0.3, 3.7, 2.7, 3,
0.6, 2.1, 1.8, 1.9, 3.5, 1.5, 2.5, 4, 1.9, 2.1, 0.5, 2.1, 3.3, 0.9, 3.4, 4.3, 1.3, 2.3, 1.4, 1.5, 3.1, 2.5, 2.4, 1.8, 2.1, 0.6,
2.6, 2.7, 2.4, 1.5, 3.3, 4, 2.7, 3.1, 1.3, 2.1, 2.1, 1.6, 2.5, 1.8, 0.8, 1.2, 3.3, 3, 2.3, 1.9, 0.2, 2.3, 2.3, 0.5, 3.3, 0.6,
2.3, 0.9), Y = c(3.9, 9.1, 5, 9.3, 12.5, 4.9, 6.2, 4.3, 7.7, 10.9, 10.7, 6.8, 7.5, 6.2, 9.8, 7.8, 3.3, 1.3, 9.1, 3.4, 7.4,
1.6, 7.9, 2.7, 11.3, 1.5, 6.6, 2.9, 5.5, 3.6, 10.9, 10.1, 5, 5.4, 8.4, 9.6, 6.4, 3.6, 5.5, 10.3, 7.7, 2.2, -1.1, 12.1, 8.6,
9.3, 2.8, 7.5, 4.6, 6.8, 10.1, 3.4, 6.6, 13.2, 5.3, 6.5, 1.6, 7, 10.5, 3.7, 10.1, 12.8, 4.4, 4.9, 4, 4.4, 11.1, 9.8, 6.5,
5.5, 4.7, 1.2, 8.4, 8.2, 5.7, 4.6, 10.2, 10.5, 8.3, 9.1, 3, 6.3, 4.3, 6.4, 6.8, 3.7, 1.8, 2.6, 10.2, 7.2, 7.2, 5.7, -0.3, 7.4,
7.5, 3.5, 10.7, 2.7, 7.7, 0.3)), class = "data.frame", row.names = c(NA, -100L))

```

```{r}
mean_Z_new<- mean(Q2a$Z)
ATE_C<- coeffs['(Intercept)'] + coeffs['D'] + coeffs['Z'] * mean_Z_new + coeffs['D:Z'] * mean_Z_new -(coeffs['(Intercept)'] + coeffs['Z'] * mean_Z_new)

print(paste(ATE_C))

```

# 3

```{r}
Q3 <- structure(list(Y = c(16, -12, 4, 14, -32, 17, -4, -2, 35, 31, -4, 57, 23, -37, 3, 48, -25, -29, 2, 8, 16, -26,
-24, 39, -11, -14, -29, 9, 53, 18, 42, 7, -23, 22, 24, 48, 48, 20, -4, 1, 49, 39, -11, 12, 7, -13, 10, 21, -19, -33, 10,
11, 1, 9, 33, 16, 35, 31, 6, -10, 50, 28, -7, 21, 63, -14, 4, -68, 32, 47, -10, 30, -3, -3, -3, 28, -8, 26, -16, -15, 17,
-3, 54, 37, 25, 6, 36, 1, 4, -1, 9, -19, 54, 19, -30, 10, 50, 31, 11, 68), X = c(18, -8, 4, 22, -3, 12, 3, 17, -3, 12, -2,
27, 15, 11, 2, 33, 1, -19, 6, 19, 3, 0, -6, 19, -8, -2, 10, 27, 27, 11, 10, 14, 6, 6, 15, 37, 24, 26, -6, 10, 22, 25, 4,
12, 10, -11, 6, 6, -4, 3, 30, -5, 9, 4, 24, 5, 16, 4, -15, -2, 15, 24, -6, 13, 25, -8, 11, -18, 16, 25, 8, 5, 2, 12, -2, 22,
8, 13, -7, -1, 11, 4, 23, 21, 7, 6, 14, 17, 15, 13, 14, -4, 37, 6, -10, 2, 22, 11, 19, 27), U1 = c(6, -3, 19, 15, -20,
35, 8, -6, 5, 32, -15, 34, 36, -10, 6, 26, -6, -20, -7, 29, 24, -10, 1, 30, -12, 2, 4, 28, 52, 21, 26, 12, -9, 16, 0, 41,
33, 23, -3, 16, 18, 7, -4, 9, 6, -30, 36, 20, -2, -9, 22, 21, 11, 11, 30, -5, 16, 20, -7, -1, 23, 23, 18, -2, 32, -4, 5,
-32, 26, 43, -1, 31, 4, 24, -9, 17, -8, 8, -19, -4, 23, -10, 42, 29, 28, 3, 29, 9, 0, 32, 19, 4, 45, 22, -17, -2, 41, 32, 5,
49), U2 = c(14, 19, -9, 11, 2, 6, 16, 22, -12, 6, 9, 23, 27, 16, 14, 7, 15, 1, 12, 8, -2, 15, 10, 8, 9, -1, 32, 10, 23,
13, 8, 17, 17, 0, 12, 25, 19, 20, -15, 14, 14, 19, 13, 18, 5, 16, 8, 7, 1, 25, 23, -9, 2, 9, 24, 10, 1, 2, -14, -2, 3, 12,
-1, 7, 17, 4, 14, 3, 0, 6, 13, -2, 14, 13, 13, 21, 11, 2, 6, 6, 0, 12, 12, 12, 4, 15, 10, 24, 16, 18, -4, 7, 22, 3, -3, 15,
14, 20, 13, -5), U3 = c(12, 6, 19, 28, 20, 21, 7, 20, 10, 26, 12, 0, 7, 15, -2, 13, 5, 6, 4, 23, 18, 4, 18, -2, 5, 10, 5,
22, 3, 12, 4, 11, -1, -2, 8, 12, 23, -3, 19, 12, 20, 23, 19, 0, -2, -6, 11, 10, 15, 8, 23, 8, -10, 17, 22, 1, 4, 13, 20, 20,
6, 10, 6, 10, 28, -1, 0, -3, 17, -2, 17, 6, 9, 20, 10, 14, 23, -14, -4, 5, 10, 16, 30, 15, 15, -11, 4, 4, 15, 9, 25, 22, 16,
10, 6, 7, 23, 20, 17, 16), U4 = c(12, 5, 3, 6, -17, 11, 11, 13, 5, 27, -5, 33, 26, -19, 8, 32, 10, -16, 6, -8, 10, -1,
-22, 15, -3, 7, 9, 15, 23, 24, 33, 11, -16, 2, 9, 47, 23, 30, -4, 10, 34, 39, 4, 27, 11, -8, 18, 8, -16, -5, 13, -8, 9, 4,
33, 9, 31, 14, -11, -7, 11, 16, -3, 13, 29, -4, -1, -21, 13, 29, 4, 14, 9, -5, 14, 28, -5, 3, 5, -7, 6, 8, 25, 17, 25, 14,
26, 20, 13, 7, 17, -17, 43, 14, -18, 19, 49, 25, 12, 52)), class = "data.frame", row.names = c(NA, -100L))

```

## find S

```{r}
attach(Q3)
summary(lm(Y~X+U1))
summary(lm(Y~X+U2))
summary(lm(Y~X+U3)) # U3 is S
summary(lm(Y~X+U4))
```

According to summaries, U3 is S. Since U3 is insignificant, so X is explained by U3. This indicates S to X to Y.

## using S to find others

```{r}
summary(lm(U1~X+U3))
summary(lm(U2~X+U3))
summary(lm(U4~X+U3))
```

U2 is Z, since Z is not affect X by S

## determine M and W using Z

there is a path Z to Y to W

```{r}
summary(lm(U1~Y+U2))
summary(lm(U4~Y+U2))
```

W is U1. in U1 \~ Y + U2, U2 is insignificant,which means Y also explain U2, so U1 is W by the path Z to Y to W.

M is U4. in U4 \~ Y + U2, U4 are explained by Y and U2(Z).We need more information. And by checking U2\~X+U4

```{r}
summary(lm(U2~X+U4)) #U2 is Z, suppose the path is Z to X to M
```

U4 also explain X, this is the path Z to X to M. so U4 is M.

And check U1\~Y+U4, which is M to Y to W

```{r}
summary(lm(U1~Y+U4))
```

The result shows U4 is insignificant, which means Y is explained by U4. this fits M to Y to W

## result

U1 is W. U2 is Z. U3 is S. U4 is M.
